<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="mayor.css">
        <title>花蓮縣</title>
        <style>

            #data-container{
                position: absolute;
                bottom: 20px;
                right: 20px;
                font-size: 20px;
                color: white;
            }   

            #data-container p{
                margin:5px;
            }

            #data-container button{
                margin: 0px 20px 0px 20px;
            }

        </style>
    </head>
    <body>
        <div class="title_place">
            <h1>花蓮縣縣長投票</h1>
        </div>
        <!--<iframe src=https://bulletin.cec.gov.tw/01選舉公報/04縣市長/111年/花蓮縣縣長.pdf></iframe>-->
        <div id="data-container"></div>
        <div id="test"></div>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

        <script>
            
            // https://dev.to/ramonak/javascript-how-to-access-the-return-value-of-a-promise-object-1bck

            var candidates_list = []
            function load (url) {
            return new Promise(async function (resolve, reject) {
                // do async thing
                const res = await fetch(url)

                // resolve
                resolve(res.json()) // see note below!
            })
            }

            // run the function and receive a Promise
            const promise = load('http://134.209.77.233/region_data')

            // let the Promise know what you want to do when it resolves
            // promise.then(console.log)
            
            promise.then(result =>{
                candidates_list = result.filter(i => i.name === '花蓮縣')[0].candidates
                console.log(result.filter(i => i.name === '花蓮縣')[0].candidates)
                
                
                for(var i=0 ; i < candidates_list.length ; i++){
                    document.getElementById("data-container").innerHTML += `<p> ${candidates_list[i].name} <button id = "button_${i}"> 投票 </p>`;
                };
                
                // https://nickang.com/2018-03-06-add-event-listener-for-loop-problem-in-javascript/
                var button_id_list = document.querySelectorAll('button');
                console.log(button_id_list);
                var logButtonIndex = function(buttonIndex){
                    const data = { name:`${candidates_list[buttonIndex].name}` , votes: candidates_list[buttonIndex].votes+1 };

                    fetch('134.209.77.233/post_data',{
                        method:'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                        })
                        .then(response => response.text())
                        .then(result => {
                            console.log(result);
                        })
                        .catch(error => {
                        console.error(error);
                    }); 
                };

                button_id_list.forEach(function(button,index){
                    button.addEventListener('click',function(){
                        logButtonIndex(index);
                    });
                });
            });
            
        </script>  


    </body>
    </html>